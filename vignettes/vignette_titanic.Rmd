---
title: "Survival on the RMS Titanic"
author: "Przemyslaw Biecek"
date: "`r Sys.Date()`"
output: rmarkdown::html_document
vignette: >
  %\VignetteIndexEntry{Survival on the RMS Titanic}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = FALSE,
  comment = "#>",
  warning = FALSE,
  message = FALSE,
  cache = TRUE
)
```

# Data for Titanic survival

Let's see an example for `DALEX` package for Titanic passengers.
First, let's see the data, we will find quite nice data from in the `titanic` package.

```{r}
library("titanic")
titanic <- titanic_train[,c("Survived", "Pclass", "Sex", "Age", "SibSp", "Parch", "Fare", "Embarked")]
titanic$Survived <- factor(titanic$Survived)
titanic$Sex <- factor(titanic$Sex)
titanic$Embarked <- factor(titanic$Embarked)
levels(titanic$Embarked)[1] = "N"
titanic <- na.omit(titanic)
head(titanic)
```

# Model for Titanic survival

Ok, not it's time to create a model. Let's use the Random Forest model.

```{r}
# prepare model
library("randomForest")
rf_model <- randomForest(Survived ~ .,  data = titanic)
rf_model
```

# Explainer for Titanic survival

The third step (it's optional but useful) is to create a `DALEX` explainer for random forest model.

```{r}
library("DALEX")
rf_explain <- explain(rf_model, data = titanic[,-1],
                      y = titanic$Survived == "1", label = "Random Forest v7")
```

# Variable importance plots

Use the `variable_importance()` explainer to present importance of particular features. Note that `type = "difference"` normalizes dropouts, and now they all start in 0.

```{r}
vi_rf <- variable_importance(rf_explain, type = "difference")
head(vi_rf)
plot(vi_rf)
```

# Variable effects

As we see the most important feature is `Sex`. Next three importnat features are `Pclass`, `Age` and `Fare`. Let's see the link between model response and these features.

Such univariate relation can be calculated with `variable_response()`.

## Age

Kids 5 years old and younger have much higher survival probability.

```{r}
vr_age  <- variable_response(rf_explain, variable =  "Age")
head(vr_age)
plot(vr_age, use_facets = TRUE)
```

## Pclass

Passangers in the first class have much higher survival probability.

```{r}
vr_pclass  <- variable_response(rf_explain, variable =  "Pclass")
plot(vr_pclass, use_facets = TRUE)
```

## Fare

Very cheap tickets are linked with lower chances.

```{r}
vr_fare  <- variable_response(rf_explain, variable =  "Fare")
plot(vr_fare, use_facets = TRUE)
```

## Embarked

Passangers that embarked from C have highest survival.

```{r}
vr_embarked  <- variable_response(rf_explain, variable =  "Embarked")
plot(vr_embarked)
```


# Instance level explanations

Let's see break down explanation for model predictions for 8 years old male from 1st class that embarked from port C.

```{r}
new_passanger <- data.frame(
  Pclass = 1,
  Sex = factor("male", levels = c("female", "male")),
  Age = 8,
  SibSp = 0,
  Parch = 0,
  Fare = 72,
  Embarked = factor("C", levels = c("N","C","Q","S"))
)

sp_rf <- single_prediction(rf_explain, new_passanger)
plot(sp_rf)
```

It looks like the most important feature for this passenger is `Age` and `Sex`. After all his odds for survival are higher than for the average passenger. Mainly because of the young age and despite of being a male.

# More models

Let's train more models for survival.
 
## Logistic regression

```{r}
library("rms")
lmr_model <- lrm(Survived == "1" ~ Pclass + Sex + rcs(Age) + SibSp +
                   Parch + Fare + Embarked, titanic)
lmr_explain <- explain(lmr_model, data = titanic, 
                       y = titanic$Survived == "1", 
                       predict_function = function(m,x) predict(m, x, type="fitted"),
                       label = "Logistic regression")
```
 
## Generalized Boosted Models (GBM)

```{r}
library("gbm")
gbm_model <- gbm(Survived == "1" ~ Pclass + Sex + Age + SibSp +
                     Parch + Fare + Embarked, data = titanic, n.trees = 15000)
gbm_explain <- explain(gbm_model, data = titanic, 
                       y = titanic$Survived == "1", 
                       predict_function = function(m,x) predict(m, x, n.trees = 15000, type = "response"),
                       label = "Generalized Boosted Models")
```
 
## Support Vector Machines (SVM)

```{r}
library("e1071")
svm_model <- svm(Survived == "1" ~ Pclass + Sex + Age + SibSp +
                     Parch + Fare + Embarked, data = titanic, 
             type = "C-classification", probability = TRUE)
svm_explain <- explain(svm_model, data = titanic, 
                       y = titanic$Survived == "1", 
                       label = "Support Vector Machines")
```
 
## k-Nearest Neighbours (kNN)

```{r}
library("caret")
knn_model <- knn3(Survived == "1" ~ Pclass + Sex + Age + SibSp +
                     Parch + Fare + Embarked, data = titanic, k = 5)
knn_explain <- explain(knn_model, data = titanic, 
                       y = titanic$Survived == "1", 
                       predict_function = function(m,x) predict(m, x)[,2],
                       label = "k-Nearest Neighbours")
```

## Variable performance

```{r, fig.width=5, fig.height=7}
vi_rf <- variable_importance(rf_explain)
vi_lmr <- variable_importance(lmr_explain)
vi_gbm <- variable_importance(gbm_explain)
vi_svm <- variable_importance(svm_explain)
vi_knn <- variable_importance(knn_explain)

plot(vi_rf, vi_lmr, vi_gbm, vi_svm, vi_knn, bar_width = 4)
```

## Single variable

```{r, fig.width=5, fig.height=5}
vr_age_rf  <- variable_response(rf_explain, variable =  "Age")
vr_age_lmr  <- variable_response(lmr_explain, variable =  "Age")
vr_age_gbm  <- variable_response(gbm_explain, variable =  "Age")
vr_age_svm  <- variable_response(svm_explain, variable =  "Age")
vr_age_knn  <- variable_response(knn_explain, variable =  "Age")
plot(vr_age_rf, vr_age_lmr, vr_age_gbm, vr_age_svm, vr_age_knn)
```

# Instance level explanations

```{r, fig.width=5, fig.height=8}
sp_rf <- single_prediction(rf_explain, new_passanger)
sp_lmr <- single_prediction(lmr_explain, new_passanger)
sp_gbm <- single_prediction(gbm_explain, new_passanger)
sp_svm <- single_prediction(svm_explain, new_passanger)
sp_knn <- single_prediction(knn_explain, new_passanger)
plot(sp_rf, sp_lmr, sp_gbm, sp_svm, sp_knn)
```

# Session info

```{r}
sessionInfo()
```
